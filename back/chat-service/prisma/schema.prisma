generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("CHAT_DATABASE_URL")
}

model conversations {
  conversation_id String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type            conversation_type
  name            String?                @db.VarChar(100)
  created_at      DateTime?              @default(now()) @db.Timestamp(6)
  subtype         private_type?
  members         conversation_members[]
  messages        messages[]
}

model conversation_members {
  conversation_id       String        @db.Uuid
  user_id               String        @db.Uuid
  joined_at             DateTime?     @default(now()) @db.Timestamp(6)
  pubkey                String?
  last_read_message_id  String?       @db.Uuid
  last_read_message     messages?     @relation("MemberLastRead", fields: [last_read_message_id], references: [message_id], onDelete: NoAction)

  conversation          conversations @relation(fields: [conversation_id], references: [conversation_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([conversation_id, user_id])
}

model messages {
  message_id      String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id String?              @db.Uuid
  sender_id       String               @db.Uuid
  content         String
  sent_at         DateTime?            @default(now()) @db.Timestamp(6)
  is_read         Boolean?             @default(false)
  deliveries      message_deliveries[]
  conversation    conversations?       @relation(fields: [conversation_id], references: [conversation_id], onDelete: Cascade, onUpdate: NoAction)

  members_last_read conversation_members[] @relation("MemberLastRead")
}

model message_deliveries {
  message_id   String    @db.Uuid
  user_id      String    @db.Uuid
  delivered_at DateTime? @db.Timestamp(6)
  read_at      DateTime? @db.Timestamp(6)
  message      messages  @relation(fields: [message_id], references: [message_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([message_id, user_id])
}

enum conversation_type {
  private
  group
}

enum private_type {
  normal
  secret
}
